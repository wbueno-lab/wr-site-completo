<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teste Edge Functions - Mercado Pago</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    
    .container {
      background: white;
      border-radius: 8px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    h1 {
      color: #333;
      margin-top: 0;
    }
    
    h2 {
      color: #666;
      font-size: 18px;
      margin-top: 24px;
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 8px;
    }
    
    .input-group {
      margin-bottom: 16px;
    }
    
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: #555;
    }
    
    input, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }
    
    textarea {
      min-height: 80px;
      font-family: monospace;
      resize: vertical;
    }
    
    button {
      background: #059669;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.2s;
    }
    
    button:hover {
      background: #047857;
    }
    
    button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    
    .result {
      margin-top: 16px;
      padding: 16px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-family: monospace;
      font-size: 13px;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .result.success {
      background: #d1fae5;
      border-color: #059669;
      color: #065f46;
    }
    
    .result.error {
      background: #fee2e2;
      border-color: #dc2626;
      color: #991b1b;
    }
    
    .result.loading {
      background: #dbeafe;
      border-color: #3b82f6;
      color: #1e40af;
    }
    
    .info {
      background: #eff6ff;
      border: 1px solid #3b82f6;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 20px;
      font-size: 14px;
      color: #1e40af;
    }
    
    .warning {
      background: #fef3c7;
      border: 1px solid #f59e0b;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 20px;
      font-size: 14px;
      color: #92400e;
    }
    
    .test-section {
      border-top: 1px solid #e5e7eb;
      padding-top: 20px;
      margin-top: 20px;
    }
    
    .test-section:first-child {
      border-top: none;
      padding-top: 0;
      margin-top: 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üß™ Teste de Edge Functions - Mercado Pago</h1>
    
    <div class="warning">
      ‚ö†Ô∏è <strong>Importante:</strong> Configure suas credenciais do Supabase abaixo antes de testar.
    </div>
    
    <div class="input-group">
      <label for="supabaseUrl">üîó Supabase URL</label>
      <input 
        type="text" 
        id="supabaseUrl" 
        placeholder="https://seu-projeto.supabase.co"
        value="https://fflomlvtgaqbzrjnvqaz.supabase.co"
      />
    </div>
    
    <div class="input-group">
      <label for="supabaseKey">üîë Supabase Anon Key</label>
      <input 
        type="password" 
        id="supabaseKey" 
        placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
      />
    </div>
  </div>

  <!-- Teste 1: Get Installments -->
  <div class="container">
    <div class="test-section">
      <h2>1. Teste: Buscar Parcelas (Get Installments)</h2>
      
      <div class="info">
        ‚ÑπÔ∏è Esta fun√ß√£o busca as op√ß√µes de parcelamento dispon√≠veis para um valor espec√≠fico.
      </div>
      
      <div class="input-group">
        <label for="amount">üí∞ Valor (R$)</label>
        <input 
          type="number" 
          id="amount" 
          placeholder="1000.00"
          value="1024.80"
          step="0.01"
        />
      </div>
      
      <div class="input-group">
        <label for="paymentMethodId">üí≥ M√©todo de Pagamento</label>
        <input 
          type="text" 
          id="paymentMethodId" 
          placeholder="visa"
          value="visa"
        />
      </div>
      
      <button onclick="testGetInstallments()">üöÄ Testar Get Installments</button>
      
      <div id="result1" class="result" style="display: none;"></div>
    </div>
  </div>

  <!-- Teste 2: Check Payment -->
  <div class="container">
    <div class="test-section">
      <h2>2. Teste: Verificar Status do Pagamento (Check Payment)</h2>
      
      <div class="info">
        ‚ÑπÔ∏è Esta fun√ß√£o verifica o status de um pagamento existente no Mercado Pago.
      </div>
      
      <div class="input-group">
        <label for="paymentId">üÜî Payment ID</label>
        <input 
          type="text" 
          id="paymentId" 
          placeholder="123456789"
        />
      </div>
      
      <button onclick="testCheckPayment()">üöÄ Testar Check Payment</button>
      
      <div id="result2" class="result" style="display: none;"></div>
    </div>
  </div>

  <!-- Teste 3: Conex√£o B√°sica -->
  <div class="container">
    <div class="test-section">
      <h2>3. Teste: Conectividade B√°sica</h2>
      
      <div class="info">
        ‚ÑπÔ∏è Testa a conectividade b√°sica com o Supabase e Edge Functions.
      </div>
      
      <button onclick="testConnectivity()">üöÄ Testar Conectividade</button>
      
      <div id="result3" class="result" style="display: none;"></div>
    </div>
  </div>

  <script>
    // Fun√ß√£o auxiliar para fazer requisi√ß√µes
    async function makeRequest(endpoint, body = null) {
      const url = document.getElementById('supabaseUrl').value.trim();
      const key = document.getElementById('supabaseKey').value.trim();
      
      if (!url || !key) {
        throw new Error('Configure a URL e a Key do Supabase antes de testar');
      }
      
      const fullUrl = `${url}/functions/v1/${endpoint}`;
      
      const options = {
        method: body ? 'POST' : 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${key}`
        }
      };
      
      if (body) {
        options.body = JSON.stringify(body);
      }
      
      const response = await fetch(fullUrl, options);
      const data = await response.json();
      
      return {
        status: response.status,
        ok: response.ok,
        data
      };
    }
    
    // Fun√ß√£o para exibir resultado
    function showResult(elementId, result, isSuccess) {
      const element = document.getElementById(elementId);
      element.style.display = 'block';
      element.className = `result ${isSuccess ? 'success' : 'error'}`;
      element.textContent = typeof result === 'object' 
        ? JSON.stringify(result, null, 2) 
        : result;
    }
    
    // Fun√ß√£o para mostrar loading
    function showLoading(elementId) {
      const element = document.getElementById(elementId);
      element.style.display = 'block';
      element.className = 'result loading';
      element.textContent = '‚è≥ Carregando...';
    }
    
    // Teste 1: Get Installments
    async function testGetInstallments() {
      const resultId = 'result1';
      showLoading(resultId);
      
      try {
        const amount = parseFloat(document.getElementById('amount').value);
        const paymentMethodId = document.getElementById('paymentMethodId').value;
        
        console.log('üîç Testando Get Installments...', { amount, paymentMethodId });
        
        const result = await makeRequest('mercado-pago-get-installments', {
          amount,
          paymentMethodId
        });
        
        console.log('‚úÖ Resposta recebida:', result);
        
        if (result.ok) {
          showResult(resultId, {
            status: '‚úÖ Sucesso',
            statusCode: result.status,
            data: result.data,
            parcelas: result.data.installments?.length || 0
          }, true);
        } else {
          showResult(resultId, {
            status: '‚ùå Erro',
            statusCode: result.status,
            error: result.data
          }, false);
        }
      } catch (error) {
        console.error('‚ùå Erro:', error);
        showResult(resultId, {
          status: '‚ùå Erro de Conex√£o',
          message: error.message
        }, false);
      }
    }
    
    // Teste 2: Check Payment
    async function testCheckPayment() {
      const resultId = 'result2';
      showLoading(resultId);
      
      try {
        const paymentId = document.getElementById('paymentId').value;
        
        if (!paymentId) {
          throw new Error('Informe o Payment ID');
        }
        
        console.log('üîç Testando Check Payment...', { paymentId });
        
        const result = await makeRequest('mercado-pago-check-payment', {
          paymentId
        });
        
        console.log('‚úÖ Resposta recebida:', result);
        
        if (result.ok) {
          showResult(resultId, {
            status: '‚úÖ Sucesso',
            statusCode: result.status,
            data: result.data
          }, true);
        } else {
          showResult(resultId, {
            status: '‚ùå Erro',
            statusCode: result.status,
            error: result.data
          }, false);
        }
      } catch (error) {
        console.error('‚ùå Erro:', error);
        showResult(resultId, {
          status: '‚ùå Erro de Conex√£o',
          message: error.message
        }, false);
      }
    }
    
    // Teste 3: Conectividade B√°sica
    async function testConnectivity() {
      const resultId = 'result3';
      showLoading(resultId);
      
      try {
        const url = document.getElementById('supabaseUrl').value.trim();
        const key = document.getElementById('supabaseKey').value.trim();
        
        if (!url || !key) {
          throw new Error('Configure a URL e a Key do Supabase');
        }
        
        console.log('üîç Testando conectividade...');
        
        const tests = [];
        
        // Teste 1: REST API
        tests.push({
          name: 'REST API',
          test: async () => {
            const response = await fetch(`${url}/rest/v1/`, {
              headers: {
                'apikey': key,
                'Authorization': `Bearer ${key}`
              }
            });
            return { ok: response.ok, status: response.status };
          }
        });
        
        // Teste 2: Edge Function mercado-pago-get-installments
        tests.push({
          name: 'Edge Function: mercado-pago-get-installments',
          test: async () => {
            const response = await fetch(`${url}/functions/v1/mercado-pago-get-installments`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${key}`
              },
              body: JSON.stringify({ amount: 100, paymentMethodId: 'visa' })
            });
            return { ok: response.ok, status: response.status };
          }
        });
        
        const results = [];
        
        for (const test of tests) {
          try {
            const result = await test.test();
            results.push({
              test: test.name,
              status: result.ok ? '‚úÖ OK' : '‚ùå Falhou',
              statusCode: result.status
            });
          } catch (error) {
            results.push({
              test: test.name,
              status: '‚ùå Erro',
              error: error.message
            });
          }
        }
        
        const allOk = results.every(r => r.status === '‚úÖ OK');
        
        showResult(resultId, {
          status: allOk ? '‚úÖ Todos os testes passaram' : '‚ö†Ô∏è Alguns testes falharam',
          tests: results
        }, allOk);
        
      } catch (error) {
        console.error('‚ùå Erro:', error);
        showResult(resultId, {
          status: '‚ùå Erro de Conex√£o',
          message: error.message
        }, false);
      }
    }
  </script>
</body>
</html>

