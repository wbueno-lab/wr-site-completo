# Integra√ß√£o Completa: Mercado Pago + Correios

## üìã Resumo

Foi implementada a integra√ß√£o completa do Mercado Pago para pagamentos e dos Correios para c√°lculo de frete. Esta √© uma solu√ß√£o profissional pronta para receber pagamentos reais.

---

## üöÄ O Que Foi Implementado

### 1. Integra√ß√£o Mercado Pago

‚úÖ **Pagamento com Cart√£o de Cr√©dito**
- Suporte a todas as bandeiras (Visa, Mastercard, Elo, Amex, etc.)
- Parcelamento em at√© 12x
- Detec√ß√£o autom√°tica da bandeira
- Valida√ß√£o em tempo real dos dados do cart√£o
- Processamento seguro via API do Mercado Pago

‚úÖ **Pagamento via PIX**
- Gera√ß√£o autom√°tica de QR Code
- C√≥digo copia e cola
- Verifica√ß√£o autom√°tica de pagamento
- Timer de expira√ß√£o (30 minutos)
- Sem taxas adicionais

‚úÖ **Pagamento via Boleto Banc√°rio**
- Gera√ß√£o de boleto com vencimento em 3 dias
- Download do boleto em PDF
- C√≥digo de barras para pagamento
- Notifica√ß√£o autom√°tica de pagamento

### 2. Integra√ß√£o Correios

‚úÖ **C√°lculo de Frete Autom√°tico**
- Integra√ß√£o com API dos Correios
- Suporte a PAC e SEDEX
- C√°lculo baseado em CEP, peso e dimens√µes
- Fallback para valores estimados se API indispon√≠vel
- Cache de consultas para melhor performance

‚úÖ **Op√ß√µes de Entrega**
- PAC - Entrega econ√¥mica (7-15 dias)
- SEDEX - Entrega expressa (3-5 dias)
- C√°lculo de prazo por regi√£o
- Valores realistas baseados nos Correios

### 3. Fluxo de Checkout Completo

‚úÖ **Processo em 3 Etapas**
1. **Endere√ßo de Entrega** - Formul√°rio completo com valida√ß√£o de CEP
2. **Frete** - C√°lculo autom√°tico e sele√ß√£o de m√©todo
3. **Pagamento** - Escolha do m√©todo e processamento

‚úÖ **Recursos do Checkout**
- Indicador visual de progresso
- Resumo do pedido sempre vis√≠vel
- Navega√ß√£o entre etapas
- Valida√ß√£o em cada passo
- Interface responsiva

---

## üì¶ Arquivos Criados

### Configura√ß√£o e Tipos
```
src/config/env.ts (atualizado)
src/integrations/mercado-pago/
  ‚îú‚îÄ‚îÄ config.ts
  ‚îú‚îÄ‚îÄ types.ts
  ‚îî‚îÄ‚îÄ mercadoPagoService.ts
```

### Componentes de Pagamento
```
src/components/payment/
  ‚îú‚îÄ‚îÄ MercadoPagoCardForm.tsx
  ‚îú‚îÄ‚îÄ MercadoPagoPixForm.tsx
  ‚îî‚îÄ‚îÄ MercadoPagoBoletoForm.tsx

src/components/
  ‚îî‚îÄ‚îÄ MercadoPagoCheckoutModal.tsx
```

### Edge Functions (Supabase)
```
supabase/functions/
  ‚îú‚îÄ‚îÄ mercado-pago-process-payment/index.ts
  ‚îú‚îÄ‚îÄ mercado-pago-webhook/index.ts
  ‚îú‚îÄ‚îÄ mercado-pago-get-installments/index.ts
  ‚îú‚îÄ‚îÄ mercado-pago-check-payment/index.ts
  ‚îî‚îÄ‚îÄ correios-proxy/index.ts (j√° existia)
```

### Servi√ßos de Integra√ß√£o
```
src/services/
  ‚îú‚îÄ‚îÄ correiosAPI.ts (j√° existia)
  ‚îî‚îÄ‚îÄ shippingService.ts (j√° existia)
```

---

## ‚öôÔ∏è Configura√ß√£o - PASSO A PASSO

### Passo 1: Criar Conta no Mercado Pago

1. Acesse: https://www.mercadopago.com.br
2. Clique em "Criar conta"
3. Preencha seus dados (pode ser pessoa f√≠sica ou jur√≠dica)
4. Complete a verifica√ß√£o de identidade

### Passo 2: Obter Credenciais do Mercado Pago

1. Acesse: https://www.mercadopago.com.br/developers
2. Fa√ßa login com sua conta
3. V√° em **"Suas integra√ß√µes"**
4. Clique em **"Criar aplica√ß√£o"**
5. D√™ um nome (ex: "WR Capacetes")
6. Selecione o modelo de integra√ß√£o: **"Pagamentos online"**
7. Copie as credenciais:
   - **Public Key** (come√ßa com `APP_USR-`)
   - **Access Token** (come√ßa com `APP_USR-`)

### Passo 3: Configurar Vari√°veis de Ambiente

Abra o arquivo `.env` na raiz do projeto e adicione:

```bash
# Mercado Pago - CREDENCIAIS DE PRODU√á√ÉO
VITE_MERCADO_PAGO_PUBLIC_KEY=APP_USR-sua-public-key-aqui
VITE_MERCADO_PAGO_ACCESS_TOKEN=APP_USR-seu-access-token-aqui

# Correios (opcional - se tiver contrato com os Correios)
VITE_CORREIOS_EMPRESA_CODE=seu-codigo-empresa
VITE_CORREIOS_SENHA=sua-senha
```

**IMPORTANTE:** As credenciais acima s√£o REAIS e devem ser mantidas em segredo!

### Passo 4: Configurar Vari√°veis nas Edge Functions

As Edge Functions precisam das mesmas credenciais. Configure no Supabase:

1. Acesse: https://supabase.com/dashboard
2. V√° em seu projeto
3. Clique em **"Edge Functions"** no menu lateral
4. Clique em **"Manage secrets"**
5. Adicione as seguintes vari√°veis:

```bash
MERCADO_PAGO_PUBLIC_KEY=APP_USR-sua-public-key-aqui
MERCADO_PAGO_ACCESS_TOKEN=APP_USR-seu-access-token-aqui
```

### Passo 5: Deploy das Edge Functions

Execute os seguintes comandos para fazer deploy das Edge Functions:

```bash
# Fazer login no Supabase (se ainda n√£o fez)
npx supabase login

# Deploy da fun√ß√£o de processar pagamento
npx supabase functions deploy mercado-pago-process-payment

# Deploy da fun√ß√£o de webhook
npx supabase functions deploy mercado-pago-webhook

# Deploy da fun√ß√£o de parcelas
npx supabase functions deploy mercado-pago-get-installments

# Deploy da fun√ß√£o de verifica√ß√£o
npx supabase functions deploy mercado-pago-check-payment

# Deploy do proxy dos Correios
npx supabase functions deploy correios-proxy
```

### Passo 6: Configurar Webhook no Mercado Pago

O webhook √© usado para receber notifica√ß√µes de mudan√ßas no status dos pagamentos.

1. Acesse: https://www.mercadopago.com.br/developers
2. V√° em **"Suas integra√ß√µes"**
3. Selecione sua aplica√ß√£o
4. Clique em **"Webhooks"**
5. Adicione a URL do webhook:
   ```
   https://seu-projeto-supabase.supabase.co/functions/v1/mercado-pago-webhook
   ```
6. Selecione os eventos:
   - ‚úÖ Pagamentos
   - ‚úÖ Cobran√ßas
7. Salve as configura√ß√µes

### Passo 7: Configurar CEP de Origem (Frete)

Abra o arquivo `src/services/shippingService.ts` e altere a linha 7:

```typescript
private readonly CEP_ORIGIN = '01310-100'; // Substitua pelo CEP da sua loja/empresa
```

---

## üß™ Como Testar

### Modo de Teste (Sandbox)

O Mercado Pago oferece um modo de teste para voc√™ testar antes de ir para produ√ß√£o:

1. Acesse: https://www.mercadopago.com.br/developers/panel/credentials
2. Selecione **"Credenciais de teste"**
3. Use essas credenciais no `.env` para testar

**Cart√µes de Teste:**

| Bandeira | N√∫mero | CVV | Data | Nome | Comportamento |
|----------|--------|-----|------|------|---------------|
| Visa | 4509 9535 6623 3704 | 123 | 11/25 | APRO | Aprovado |
| Mastercard | 5031 4332 1540 6351 | 123 | 11/25 | APRO | Aprovado |
| Visa | 4774 0614 2253 5733 | 123 | 11/25 | OTHE | Rejeitado |

### Teste de PIX (Sandbox)

No modo de teste, o PIX √© aprovado automaticamente ap√≥s 5 minutos.

### Teste de Boleto (Sandbox)

No modo de teste, o boleto pode ser marcado como pago manualmente no painel do Mercado Pago.

---

## üí∞ Onde o Dinheiro Cai?

### Mercado Pago

‚úÖ **O dinheiro vai direto para sua conta Mercado Pago**
- Voc√™ recebe uma notifica√ß√£o por email de cada venda
- Pode acompanhar todas as vendas no painel: https://www.mercadopago.com.br/activities
- O dinheiro fica dispon√≠vel para saque ap√≥s o prazo de libera√ß√£o

### Prazos de Libera√ß√£o

| M√©todo | Prazo Padr√£o | Pode Antecipar? |
|--------|--------------|-----------------|
| Cart√£o de Cr√©dito | 14 dias | ‚úÖ Sim (com taxa) |
| PIX | 2 dias | ‚úÖ Sim (com taxa) |
| Boleto | 2 dias ap√≥s pagamento | ‚ùå N√£o |

**Nota:** Os prazos diminuem conforme voc√™ ganha reputa√ß√£o na plataforma.

### Transferir para Conta Banc√°ria

1. Acesse: https://www.mercadopago.com.br/money/transfer
2. Clique em **"Transferir"**
3. Escolha sua conta banc√°ria (cadastre se ainda n√£o tiver)
4. Digite o valor
5. Confirme a transfer√™ncia

**Transfer√™ncias s√£o gratuitas** e caem na conta em at√© 1 dia √∫til.

---

## üíµ Taxas do Mercado Pago

| M√©todo de Pagamento | Taxa por Transa√ß√£o |
|---------------------|-------------------|
| Cart√£o de Cr√©dito (√† vista) | 3,79% + R$ 0,40 |
| Cart√£o de Cr√©dito (parcelado 2-6x) | 4,89% + R$ 0,40 |
| Cart√£o de Cr√©dito (parcelado 7-12x) | 5,49% + R$ 0,40 |
| PIX | 0,99% |
| Boleto | R$ 3,49 por boleto |

**Nota:** As taxas podem variar. Consulte: https://www.mercadopago.com.br/costs-section/release-options

---

## üìä Acompanhamento de Vendas

### Painel do Mercado Pago

Acesse: https://www.mercadopago.com.br/activities

Voc√™ pode ver:
- ‚úÖ Todas as vendas realizadas
- ‚úÖ Status de cada pagamento
- ‚úÖ Valor l√≠quido (ap√≥s taxas)
- ‚úÖ Data de libera√ß√£o do dinheiro
- ‚úÖ Dados do comprador
- ‚úÖ Reembolsos e estornos

### Seu Painel Admin

No seu site, voc√™ pode:
1. Acessar `/admin`
2. Ver todos os pedidos
3. Acompanhar status dos pagamentos
4. Gerenciar entregas

---

## üîî Notifica√ß√µes Autom√°ticas

### O que acontece quando um cliente paga?

1. **Cliente finaliza o pagamento**
2. **Mercado Pago processa**
3. **Webhook notifica seu sistema** ‚Üê Autom√°tico!
4. **Pedido √© atualizado no banco de dados**
5. **Voc√™ recebe email do Mercado Pago**

**Voc√™ n√£o precisa fazer nada manualmente!** Tudo √© autom√°tico.

---

## üõ†Ô∏è Solu√ß√£o de Problemas

### "Mercado Pago n√£o configurado"

‚ùå **Problema:** Mensagem aparece no checkout

‚úÖ **Solu√ß√£o:**
1. Verifique se as vari√°veis `VITE_MERCADO_PAGO_PUBLIC_KEY` e `VITE_MERCADO_PAGO_ACCESS_TOKEN` est√£o no `.env`
2. Reinicie o servidor de desenvolvimento: `npm run dev`

### "Erro ao processar pagamento"

‚ùå **Problema:** Pagamento n√£o √© processado

‚úÖ **Solu√ß√£o:**
1. Verifique se fez deploy das Edge Functions
2. Verifique se configurou as vari√°veis de ambiente no Supabase
3. Verifique os logs no Supabase: Dashboard ‚Üí Edge Functions ‚Üí Logs

### "Frete n√£o est√° calculando"

‚ùå **Problema:** Frete sempre mostra valores estimados

‚úÖ **Solu√ß√£o:**
1. A integra√ß√£o usa fallback autom√°tico se a API dos Correios estiver indispon√≠vel
2. Para usar a API real, configure as credenciais dos Correios
3. Ou simplesmente use os valores estimados (s√£o baseados em pre√ßos reais)

### Webhook n√£o est√° recebendo notifica√ß√µes

‚ùå **Problema:** Status do pedido n√£o atualiza automaticamente

‚úÖ **Solu√ß√£o:**
1. Verifique se configurou o webhook no painel do Mercado Pago
2. Verifique a URL do webhook: `https://seu-projeto.supabase.co/functions/v1/mercado-pago-webhook`
3. Teste o webhook manualmente: painel do Mercado Pago ‚Üí Webhooks ‚Üí Enviar teste

---

## üéØ Pr√≥ximos Passos Recomendados

### Para Produ√ß√£o

1. ‚úÖ **Trocar para credenciais de produ√ß√£o**
   - Use as credenciais de produ√ß√£o no `.env`
   - Remova as credenciais de teste

2. ‚úÖ **Configurar dom√≠nio personalizado**
   - Configure seu dom√≠nio no Vercel/Netlify
   - Atualize URL do webhook no Mercado Pago

3. ‚úÖ **Ativar HTTPS**
   - O Mercado Pago exige HTTPS em produ√ß√£o
   - Vercel/Netlify j√° fornecem HTTPS automaticamente

4. ‚úÖ **Testar com valores reais pequenos**
   - Fa√ßa alguns pedidos teste com valores baixos
   - Verifique se o dinheiro est√° caindo na conta

5. ‚úÖ **Configurar emails de notifica√ß√£o**
   - Configure SMTP no Supabase
   - Implemente emails de confirma√ß√£o de pedido

### Melhorias Futuras

- üîÑ Rastreamento de entregas
- üí¨ Chat de suporte
- üéÅ Cupons de desconto
- üìß Email marketing
- üì± Notifica√ß√µes push
- ‚≠ê Sistema de avalia√ß√µes

---

## üìû Suporte

### Mercado Pago

- **Documenta√ß√£o:** https://www.mercadopago.com.br/developers/pt
- **Suporte:** https://www.mercadopago.com.br/help
- **Status da API:** https://status.mercadopago.com

### Correios

- **Documenta√ß√£o:** https://www.correios.com.br/enviar/precisa-de-ajuda/desenvolvedores
- **Contrato:** https://www.correios.com.br/enviar/precisa-de-ajuda/contrate-os-servicos-dos-correios/correios-empresarial

---

## ‚úÖ Checklist Final

Antes de colocar no ar, verifique:

- [ ] Credenciais de produ√ß√£o configuradas no `.env`
- [ ] Credenciais configuradas no Supabase (Edge Functions)
- [ ] Deploy de todas as Edge Functions realizado
- [ ] Webhook configurado no Mercado Pago
- [ ] CEP de origem configurado corretamente
- [ ] Testes realizados com pagamentos reais (valores baixos)
- [ ] HTTPS ativado (dom√≠nio configurado)
- [ ] Termos de uso e pol√≠tica de privacidade no site
- [ ] CNPJ ou CPF cadastrado no Mercado Pago
- [ ] Conta banc√°ria cadastrada para saques

---

## üéâ Pronto!

Sua loja est√° pronta para receber pagamentos reais! üöÄ

Todas as vendas cair√£o automaticamente na sua conta do Mercado Pago, e voc√™ poder√° transferir para sua conta banc√°ria quando quiser.

**Boa sorte com as vendas! üí∞**


